# 介绍

* 一般来说，区块链是一个不可变的交易账本，维护在对等节点组成的分布式网络中。这些节点每个都会维护一份交易记录的账本副本，这些交易记录都已通过共识协议验证并写到了区块中，每个区块都包含关联到前一个区块的哈希值。
* 第一个也是最广泛认知的区块链应用是比特币，其他应用跟随了它的脚步。以太坊是采用了不同方法的另一种加密货币，集成了许多与比特币相同的特性，但添加了智能合同，以创建一个分布式应用程序平台。比特币和以太坊属于同一类区块链，我们将其归类为公共免许可区块链技术。基本上, 这些都运行在公共网络，对任何人开放，参与者可以匿名进行交互。
* 随着比特币的流行，以及以太坊和其他一些衍生技术的发展，对将区块链、分布式账本和分布式应用平台的基础技术应用于更具创新性的企业用例的兴趣也在增长。然而许多企业用例需要履行的特征是免许可区块链技术无法（目前）给予的。另外在许多用例中，参与者的身份是一项硬性要求，例如在必须遵循“了解客户”（KYC）和反洗钱（AML）法规的金融交易。

----

## 为了企业用户，我们需要考虑下面的需求：

* 参与者必须可识别且被识别
* 加入网络需要获得许可
* 高性能的交易吞吐量
* 低延迟的交易确认
* 与业务交易相关的交易和数据的隐私和机密性

----

# Hyperledger Fabric

`Hyperledger Fabric`是开源的企业级带有许可(准入机制)的分布式账本技术平台，用于企业环境。

## 关键特点

* Hyperledger是在Linux基金会下建立的，该基金会本身在开放式管理下培育开源项目的历史悠久且非常成功，这些项目可以发展强大的持续社区和蓬勃发展的生态系统。
* Fabric具有高度模块化和可配置的架构，可为各种行业包括银行、金融、保险、医疗保健、人力资源、供应链甚至数字音乐提供创新、多功能性和优化。
* Fabric是第一个支持用比如Java、Go和Node.js这样多种编程语言创建智能合约的分布式账本平台，而不是受限制于特定领域语言(DSL)。这意味着大多数企业已经拥有开发智能合约所需的技能，并且不需要额外的培训来学习新的语言或DSL。
* Fabric平台也是要许可的，这意味着与公共免许可网络不同，参与者彼此了解，不是匿名导致完全不受信任。这意味着虽然参与者可能彼此不完全信任(例如，他们可能是同一行业中的竞争者)，但网络可以在管理模型下运行，该模型基于参与者之间存在信任，例如有处理纠纷的法律协议或框架。
* 该平台最重要的区别之一是它支持可插拔的共识协议，使平台能够更有效地进行定制，以适应特定的用例和信任模型。例如，当部署在单个企业内或由可信任的权威机构运营时，完全拜占庭容错的共识可能被认为是不必要的，并且对性能和吞吐量造成过度拖累。在诸如此类的情况下，碰撞容错(CFT)共识协议可能绰绰有余，而在多方分散用例中，可能需要更传统的拜占庭容错（BFT）共识协议。
* Fabric能利用共识协议，不需要原生加密货币去激励昂贵的挖矿或为智能合约的执行提供燃料。加密货币的避免会减少一些重要的风险/攻击载体，并且加密挖矿操作的省略意味着可以使用与任何其他分布式系统大致相同的运营成本来部署平台。

这些差异化的设计特性组合使Fabric成为当今在交易处理和交易确认延迟方面性能更好的运行平台之一，并且它支持交易和智能合约(Fabric称为“链码”)的隐私和机密性。

----

# 模块化

Hyperledger Fabric被专门设计为具有模块化的架构。

* 可插拔的共识机制
* 可插拔的身份管理协议(如LDAP或OpenID Connect)
* 可插拔的密钥管理协议或密码库

## 在较高层次上，Fabric由以下模块化组件组成

* 可插拔的排序服务建立了交易排序的共识，然后广播区块到对等节点。
* 可插拔的成员资格服务提供者，负责将网络中的实体与加密身份相关联。
* 可选的P2P Gossip服务，通过排序服务向其他节点传播区块的输出。
* 智能合约(“链码”)在容器环境(例如Docker)中运行，以进行隔离。它们可以用标准编程语言编写，但不能直接访问帐本状态。
* 帐本可以通过配置来支持各种数据库。
  * LevelDB
  * CouchDB
* 可插拔的背书和验证策略，可以在每个应用程序中独立配置。

Hyperledger Fabric可以通过多种方式进行配置，以满足多种行业用例的各种解决方案要求。

# 需要许可和免许可的区块链对比

在一个免许可的区块链中，几乎任何人都可以参与，每个参与者都是匿名的。在这样的环境中，除了区块链的状态是不可变的之外，不存在任何信任。为了减轻这种信任的缺失，免许可的区块链通常采用“挖矿”的本地加密货币或交易费用来提供经济激励，以抵消参与基于PoW的拜占庭容错共识形式的特殊成本。

另一方面，需要许可的区块链是在一组已知的、被识别的且经常经过被审查的参与者中操作区块链，这些参与者在一种产生一定程度信任的管理模型下运行。要许可的区块链提供了一种方法来保护具有共同目标但可能彼此不完全信任的一组实体之间的交互。通过依赖参与者的身份，要许可的区块链可以使用更传统的碰撞容错(CFT)或拜占庭容错(BFT)共识协议，而不需要昂贵的挖矿。

另外，在这种需要许可的环境中，参与者通过智能合约故意引入恶意代码的风险降低。首先，参与者彼此了解并且知道所有动作，无论是提交应用交易，修改网络配置还是部署智能合约，都会带着为网络和相关交易类型建立的背书策略，记录到区块链中。不是完全匿名，可以很容易地识别有罪方，并根据管理模式的条款处理事件。

----

# 智能合约

智能合约，Fabric称之为“链码”，作为受信任的分布式应用程序功能，从区块链获得其安全性/信任以及节点之间的基本共识。它是区块链应用程序的业务逻辑。

## 有三个关键点适用于智能合约，尤其是应用于平台时

* 许多智能合约在网络中同时运行，
* 它们可以动态部署(在很多情况下是任何人)，以及
* 应用程序代码应视为不受信任，甚至可能是恶意的。

## 大多数现有的支持智能合约的区块链平台在共识协议中遵循排序执行架构
* 验证并排序交易然后将它们传播到所有对等节点，
* 每个节点顺序执行交易。

----

几乎所有现有的区块链系统都可以找到排序执行架构，无论公有链还是联盟链。

在区块链中执行的与排序执行架构一起运行的智能合约必须是确定性的; 否则，可能永远不会达成共识。为了解决非确定性问题，许多平台要求智能合约以非标准或特定领域的语言(例如Solidity)编写，以便可以消除非确定性操作。这阻碍了智能合约的广泛应用，因为它要求开发人员为编写智能合同而去学习新语言并可能导致编程错误。

此外，由于所有节点都顺序执行所有交易，因此性能和规模受限。智能合约代码在系统中的每个节点上执行的事实要求采取复杂措施来保护整个系统免受潜在恶意合同的影响，以确保整个系统的弹性。

----

# 新方法

Fabric为我们称为执行->排序->验证(execute-order-validate)的交易引入了一种新的体系结构。它通过将交易流程分为三个步骤来解决排序执行(order-execute)模型面临的弹性、灵活性、可伸缩性、性能和机密性的挑战：

* 执行一个交易并检查其正确性，从而认可它，
* 通过（可插拔的）共识协议排序交易，以及
* 在将交易提交到帐本之前，根据特定于应用程序的背书策略验证交易

这种设计与排序执行范式有根本上的不同，因为Fabric在交易的排序达成最终协议之前就执行了交易。

在Fabric中，应用程序特定的背书策略指定哪些或多少对等节点需要保证正确执行给定的智能合约。因此每个交易只需要由满足交易的背书策略所必需的对等节点子集来执行（背书）。这允许并行执行，从而提高系统的整体性能和规模。在最初阶段也排除了不确定性，因为在排序之前可以滤掉不一致的结果。

因为我们已经排除了不确定性，所以Fabric是第一个能够使用标准编程语言的区块链技术。在1.1.0版本中，智能合约可以用Go或Node.js编写，而有计划在后续版本中支持包括Java的其他流行语言。

----

# 隐私和机密性

正如我们所讨论的，在一个公共的、免许可的区块链网络中，利用PoW作为其共识模型，交易在每个节点上执行。这意味着合同本身和他们处理的交易数据都不存在机密性。每个交易以及实现它的代码对于网络中的每个节点都是可见的。在这种情况下，我们用PoW提供的拜占庭容错共识来交换合同和数据的机密性。

对于许多商业/企业用例而言，这种缺乏机密性可能会有问题。例如在供应链合作伙伴网络中，某些消费者可能会获得优惠利率，作为巩固关系或促进额外销量的手段。如果每个参与者都可以看到每个合同和交易，那么就无法在完全透明的网络中维持这种业务关系 -- 每个人都希望获得优惠费率！

作为第二个例子，考虑证券行业，交易者买入（或卖出）头寸并不希望她的竞争对手知道这一点，否则他们将寻求跟进，削弱交易者的策略。

为了解决实现企业用例要求所缺乏的隐私和机密性，区块链平台采用了多种方法。所有人都有自己的权衡。

加密数据是提供机密性的一种方法; 然而，在利用PoW达成共识的免许可网络中，加密数据位于每个节点上。如果有足够的时间和计算资源，加密可能会被破解。对于许多企业用例，其信息可能受到损害的风险是不可接受的。

零知识证明(ZKP)是正在探索解决该问题的另一个研究领域，目前需权衡的是计算ZKP需要相当多的时间和计算资源。因此在这种情况下需要权衡机密性的性能。

在可以利用其他形式共识的要许可环境中，对于限制机密信息的分发可以探索一种可能的方法：仅限于授权节点可以分发机密信息。

Hyperledger Fabric是一个要许可的平台，通过其通道(channel)架构实现机密性。基本上，Fabric网络上的参与者可以在参与者子集之间建立只有得到许可的特定交易集才可见的“通道”。这可以认为是一个网络罩子。因此只有进入通道的节点才能访问智能合约(链码)和数据交易，从而保护两者的隐私和机密性。

为了提高其隐私和机密性能力，Fabric增加了对私有数据的支持，并且正在开发未来可用的零知识证明(ZKP)。这方面再做得多一点就会变得可用。

----

# 可插拔共识

交易的排序被委托给模块化组件以实现共识，这在逻辑上与执行交易和维护帐本的节点分离。具体来说就是排序服务。由于共识是模块化的，因此可以根据特定部署或解决方案的信任假设来定制其实现。这种模块化架构允许平台依赖完善的工具包进行CFT(碰撞容错)或BFT(拜占庭容错)来排序。

在当前可用的版本中，Fabric提供了使用`Kafka`和`Zookeeper`实现的CFT排序服务。在随后的版本中，Fabric将提供一个`Raft`共识排序服务，实现了`etcd/Raft`和完全分散的BFT排序服务。

另外请注意，这些并不相互排斥。Fabric网络可以具有多种排序服务，支持不同的应用或应用需求。

----